<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= typeof title !== 'undefined' ? title : 'Shared report' %></title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body id="top">
  <%- include('partials/icons') %>
  <header class="site-header site-header--minimal">
    <div class="header-inner">
      <a href="/" class="logo"><svg class="icon icon--logo" aria-hidden="true"><use href="#icon-gauge"/></svg> UPGS Perf</a>
      <span class="shared-badge">Shared report – read only</span>
    </div>
  </header>
  <main class="main">
    <div class="page report-detail report-detail--shared">
      <header class="card report-hero">
        <div class="report-hero__top">
          <h1 class="report-hero__title">Scan report</h1>
          <span class="report-hero__device"><%= (scan.options && scan.options.formFactor) === 'desktop' ? 'Desktop' : 'Mobile' %></span>
        </div>
        <a href="<%= scan.url %>" target="_blank" rel="noopener" class="report-hero__url">
          <svg class="icon" aria-hidden="true"><use href="#icon-link"/></svg>
          <span class="report-hero__url-text"><%= scan.url %></span>
        </a>
        <p class="report-hero__meta">Scanned <%= new Date(scan.created_at).toLocaleString() %></p>
      </header>

      <% if (scan.summary && scan.summary.categories && Object.keys(scan.summary.categories).length) { %>
        <section class="card report-scores">
          <h2 class="report-scores__title"><svg class="icon icon--title" aria-hidden="true"><use href="#icon-gauge"/></svg> Overview</h2>
          <div class="score-grid score-grid--report">
            <% Object.entries(scan.summary.categories).forEach(function(entry) {
              var id = entry[0];
              var score = entry[1];
              var label = id.replace(/-/g, ' ');
              label = label.split(' ').map(function(w) { return w.charAt(0).toUpperCase() + w.slice(1); }).join(' ');
            %>
              <div class="score-card score-card--report score-card--category score-card--<%= id %>">
                <span class="score-card__ring" style="--score: <%= score %>"></span>
                <span class="score-label"><%= label %></span>
                <span class="score-value"><%= score %></span>
              </div>
            <% }) %>
          </div>
        </section>
      <% } %>
      <% if (scan.summary && scan.summary.metrics && Object.keys(scan.summary.metrics).length) { %><%- include('partials/report-speed-viz', { data: scan, filmstripUrl: (typeof shareToken !== 'undefined' && shareToken) ? '/share/' + shareToken + '/filmstrip' : null }) %><% } %>
      <section class="card report-screenshot">
        <div class="report-screenshot__head">
          <h2 class="card-title">Screenshot</h2>
          <% if (scan.screenshot_path && typeof shareToken !== 'undefined') { %><a href="/share/<%= shareToken %>/screenshot" target="_blank" rel="noopener" class="report-screenshot__open">Open full size</a><% } %>
        </div>
        <% if (scan.screenshot_path && typeof shareToken !== 'undefined') { %>
          <p class="report-screenshot__caption">Page as captured at the end of the Lighthouse run. Click to view full size.</p>
          <button type="button" class="report-screenshot__preview" id="screenshot-preview" data-screenshot-src="/share/<%= shareToken %>/screenshot" aria-label="View screenshot full size">
            <img src="/share/<%= shareToken %>/screenshot" alt="Screenshot of <%= scan.url %>" class="report-screenshot__img" loading="lazy">
          </button>
        <% } else { %>
          <p class="report-screenshot__caption report-screenshot__empty">Screenshot not available for this run.</p>
        <% } %>
      </section>
      <% if (scan.screenshot_path && typeof shareToken !== 'undefined') { %>
        <div id="screenshot-overlay" class="screenshot-overlay" hidden aria-modal="true" aria-label="Screenshot full size">
          <div class="screenshot-overlay__backdrop"></div>
          <div class="screenshot-overlay__content">
            <button type="button" class="screenshot-overlay__close" aria-label="Close"><svg class="icon" aria-hidden="true"><use href="#icon-close"/></svg></button>
            <img src="/share/<%= shareToken %>/screenshot" alt="Screenshot of <%= scan.url %>" class="screenshot-overlay__img" id="screenshot-overlay-img">
          </div>
        </div>
      <% } %>

      <%- include('partials/filmstrip-overlay') %>

      <% if (scan.summary && scan.summary.recommendations && scan.summary.recommendations.length) { %>
        <section class="card report-recommendations">
          <h2 class="card-title">Needs attention</h2>
          <p class="report-recommendations__intro">Issues and opportunities from this run, ordered by impact.</p>
          <ul class="report-recommendations__list">
            <% scan.summary.recommendations.forEach(function(rec) { %>
              <li class="report-recommendations__item">
                <div class="report-recommendations__head">
                  <span class="report-recommendations__score report-recommendations__score--<%= rec.score >= 50 ? 'average' : 'poor' %>"><%= rec.score %></span>
                  <span class="report-recommendations__title"><%= rec.title %></span>
                  <% if (rec.displayValue) { %><span class="report-recommendations__value"><%= rec.displayValue %></span><% } %>
                </div>
                <% if (rec.description && typeof linkifyDescription === 'function') { %><p class="report-recommendations__desc"><%- linkifyDescription(rec.description) %></p><% } else if (rec.description) { %><p class="report-recommendations__desc"><%= rec.description %></p><% } %>
              </li>
            <% }) %>
          </ul>
        </section>
      <% } %>
      <% if (scan.summary && scan.summary.metrics && Object.keys(scan.summary.metrics).length) { %>
        <section class="card report-metrics">
          <h2 class="card-title">Key metrics</h2>
          <p class="report-metrics__intro">Core Web Vitals and loading metrics from this run.</p>
          <ul class="metrics-list metrics-list--report">
            <% Object.entries(scan.summary.metrics).forEach(function(entry) {
              var id = entry[0];
              var m = entry[1];
              var label = id.replace(/-/g, ' ');
              label = label.split(' ').map(function(w) { return w.charAt(0).toUpperCase() + w.slice(1); }).join(' ');
            %>
              <li class="metrics-list__item">
                <span class="metrics-list__label"><%= label %></span>
                <span class="metrics-list__value"><%= m.displayValue %></span>
              </li>
            <% }) %>
          </ul>
        </section>
      <% } %>
    </div>
  </main>
  <footer class="site-footer">
    <div class="footer-inner">UPGS Perf – Shared Lighthouse report (read only)</div>
  </footer>
  <script>
    (function () {
      var screenshotPreview = document.getElementById('screenshot-preview');
      var screenshotOverlay = document.getElementById('screenshot-overlay');
      if (screenshotPreview && screenshotOverlay) {
        var overlayImg = document.getElementById('screenshot-overlay-img');
        var overlayBackdrop = screenshotOverlay.querySelector('.screenshot-overlay__backdrop');
        var overlayClose = screenshotOverlay.querySelector('.screenshot-overlay__close');
        function openScreenshot() {
          if (overlayImg) overlayImg.src = screenshotPreview.getAttribute('data-screenshot-src');
          screenshotOverlay.removeAttribute('hidden');
          document.body.style.overflow = 'hidden';
        }
        function closeScreenshot() {
          screenshotOverlay.setAttribute('hidden', '');
          document.body.style.overflow = '';
        }
        screenshotPreview.addEventListener('click', openScreenshot);
        if (overlayBackdrop) overlayBackdrop.addEventListener('click', closeScreenshot);
        if (overlayClose) overlayClose.addEventListener('click', closeScreenshot);
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape' && screenshotOverlay && !screenshotOverlay.hasAttribute('hidden')) closeScreenshot();
        });
      }
    })();
  </script>
</body>
</html>
