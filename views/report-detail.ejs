<%- include('partials/header') %>
  <div class="page report-detail">
    <div id="rescan-overlay" class="scan-overlay" role="dialog" aria-modal="true" aria-labelledby="rescan-overlay-title" aria-describedby="rescan-overlay-desc" aria-busy="true" hidden>
      <div class="scan-overlay__panel">
        <div class="scan-overlay__icon" aria-hidden="true">
          <svg class="icon" aria-hidden="true"><use href="#icon-gauge"/></svg>
        </div>
        <div class="scan-overlay__spinner-wrap">
          <div class="spinner scan-overlay__spinner" aria-hidden="true"></div>
        </div>
        <h2 id="rescan-overlay-title" class="scan-overlay__title">Re-scan in progress</h2>
        <p id="rescan-overlay-url" class="scan-overlay__url" aria-hidden="true"></p>
        <p id="rescan-overlay-device" class="scan-overlay__device" aria-hidden="true"></p>
        <p class="scan-overlay__text">Re-running Lighthouse scan…</p>
        <p id="rescan-overlay-step" class="scan-overlay__step" aria-live="polite">Starting…</p>
        <p id="rescan-overlay-desc" class="scan-overlay__hint">This may take 30–60 seconds</p>
        <div class="scan-overlay__progress" aria-hidden="true"></div>
        <p class="scan-overlay__stay">Please don’t close this window</p>
      </div>
    </div>
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="report-error" role="alert">
        <p class="report-error__text"><%= error %></p>
      </div>
    <% } %>
    <nav class="report-nav">
      <a href="/dashboard" class="report-nav__back"><svg class="icon" aria-hidden="true"><use href="#icon-arrow-left"/></svg> Dashboard</a>
      <a href="/scans" class="report-nav__back"><svg class="icon" aria-hidden="true"><use href="#icon-list"/></svg> Scan history</a>
    </nav>

    <header class="card report-hero">
      <div class="report-hero__top">
        <h1 class="report-hero__title">Scan report</h1>
        <% if (!scanGroup || scanGroup.length < 2) { %>
        <span class="report-hero__device report-hero__device--<%= (scan.options && scan.options.formFactor) === 'desktop' ? 'desktop' : 'mobile' %>"><%= (scan.options && scan.options.formFactor) === 'desktop' ? 'Desktop' : 'Mobile' %></span>
        <% } else { %>
        <span class="report-hero__device report-hero__device--group">Desktop &amp; Mobile</span>
        <% } %>
      </div>
      <a href="<%= scan.url %>" target="_blank" rel="noopener" class="report-hero__url">
        <svg class="icon" aria-hidden="true"><use href="#icon-link"/></svg>
        <span class="report-hero__url-text"><%= scan.url %></span>
      </a>
      <p class="report-hero__meta">Scanned <%= new Date(scan.created_at).toLocaleString() %></p>
    </header>

    <% if (scanGroup && scanGroup.length >= 2) { %>
    <div class="report-tabs" role="tablist" aria-label="Device">
      <% scanGroup.forEach(function(s) { var isDesktop = (s.options && s.options.formFactor) === 'desktop'; var isActive = s.id === activeScanId; %>
      <button type="button" class="report-tabs__tab <%= isActive ? 'report-tabs__tab--active' : '' %>" role="tab" aria-selected="<%= isActive ? 'true' : 'false' %>" aria-controls="report-panel-<%= s.id %>" id="report-tab-<%= s.id %>" data-scan-id="<%= s.id %>"><%= isDesktop ? 'Desktop' : 'Mobile' %></button>
      <% }) %>
    </div>
    <div class="report-tab-panels">
      <% scanGroup.forEach(function(s) { var isActive = s.id === activeScanId; %>
      <div id="report-panel-<%= s.id %>" class="report-tab-panel <%= isActive ? 'report-tab-panel--active' : '' %>" role="tabpanel" aria-labelledby="report-tab-<%= s.id %>" <%= isActive ? '' : 'hidden' %>>
    <% if (s.summary && s.summary.categories && Object.keys(s.summary.categories).length) { %>
      <section class="card report-scores">
        <h2 class="report-scores__title"><svg class="icon icon--title" aria-hidden="true"><use href="#icon-gauge"/></svg> Overview</h2>
        <div class="score-grid score-grid--report">
          <% Object.entries(s.summary.categories).forEach(function(entry) {
            var id = entry[0];
            var score = entry[1];
            var label = id.replace(/-/g, ' ');
            label = label.split(' ').map(function(w) { return w.charAt(0).toUpperCase() + w.slice(1); }).join(' ');
          %>
            <div class="score-card score-card--report score-card--category score-card--<%= id %>">
              <span class="score-card__ring" style="--score: <%= score %>"></span>
              <span class="score-label"><%= label %></span>
              <span class="score-value"><%= score %></span>
            </div>
          <% }) %>
        </div>
        <% var perfScore = s.summary.categories && s.summary.categories.performance; if (typeof perfScore === 'number' && perfScore < 15) { %>
        <p class="report-scores__hint" role="note">Very low performance score. This can happen due to timeouts, network issues, or a slow environment.</p>
        <% } %>
      </section>
    <% } %>
    <% if (s.summary && s.summary.metrics && Object.keys(s.summary.metrics).length) { %><%- include('partials/report-speed-viz', { data: s, filmstripUrl: s.hasReportJson ? '/scans/' + s.id + '/filmstrip' : null }) %><% } %>
    <section class="card report-screenshot">
      <div class="report-screenshot__head">
        <h2 class="card-title">Screenshot</h2>
        <% if (s.screenshot_path) { %><a href="/scans/<%= s.id %>/screenshot" target="_blank" rel="noopener" class="report-screenshot__open">Open full size</a><% } %>
      </div>
      <% if (s.screenshot_path) { %>
        <p class="report-screenshot__caption">Page as captured at the end of the Lighthouse run. Click to view full size.</p>
        <button type="button" class="report-screenshot__preview report-screenshot-preview" data-screenshot-src="/scans/<%= s.id %>/screenshot" data-scan-id="<%= s.id %>" aria-label="View screenshot full size">
          <img src="/scans/<%= s.id %>/screenshot" alt="Screenshot of <%= s.url %>" class="report-screenshot__img" loading="lazy">
        </button>
      <% } else { %>
        <p class="report-screenshot__caption report-screenshot__empty">Screenshot not available for this run. Re-scan to capture a new one.</p>
      <% } %>
    </section>
    <% if (s.summary && s.summary.metrics && Object.keys(s.summary.metrics).length) { %>
      <section class="card report-metrics">
        <h2 class="card-title">Key metrics</h2>
        <p class="report-metrics__intro">Core Web Vitals and loading metrics from this run.</p>
        <ul class="metrics-list metrics-list--report">
          <% Object.entries(s.summary.metrics).forEach(function(entry) {
            var id = entry[0];
            var m = entry[1];
            var label = id.replace(/-/g, ' ');
            label = label.split(' ').map(function(w) { return w.charAt(0).toUpperCase() + w.slice(1); }).join(' ');
          %>
            <li class="metrics-list__item">
              <span class="metrics-list__label"><%= label %></span>
              <span class="metrics-list__value"><%= m.displayValue %></span>
            </li>
          <% }) %>
        </ul>
      </section>
    <% } %>
    <% if (s.summary && s.summary.recommendations && s.summary.recommendations.length) { %>
      <%
        var recs = s.summary.recommendations;
        var byScore = {};
        for (var ri = 0; ri < recs.length; ri++) {
          var sc = recs[ri].score;
          if (!byScore[sc]) byScore[sc] = [];
          byScore[sc].push(recs[ri]);
        }
        var scoreKeys = Object.keys(byScore).map(Number).sort(function(a, b) { return a - b; });
      %>
      <section class="card report-recommendations">
        <h2 class="card-title">Needs attention</h2>
        <p class="report-recommendations__intro">Issues and opportunities from this run, grouped by impact (score).</p>
        <div class="report-recommendations__accordion">
          <% for (var si = 0; si < scoreKeys.length; si++) {
            var scoreVal = scoreKeys[si];
            var items = byScore[scoreVal];
            var scoreClass = scoreVal >= 50 ? 'average' : 'poor';
          %>
          <details class="report-recommendations__accordion-item">
            <summary class="report-recommendations__accordion-summary">
              <span class="report-recommendations__score report-recommendations__score--<%= scoreClass %>"><%= scoreVal %></span>
              <span class="report-recommendations__accordion-label"><%= items.length %> <%= items.length === 1 ? 'issue' : 'issues' %></span>
              <svg class="icon report-recommendations__accordion-chevron" aria-hidden="true"><use href="#icon-chevron-down"/></svg>
            </summary>
            <ul class="report-recommendations__list">
              <% items.forEach(function(rec) { %>
                <li class="report-recommendations__item">
                  <div class="report-recommendations__head">
                    <span class="report-recommendations__title"><%= rec.title %></span>
                    <% if (rec.displayValue) { %><span class="report-recommendations__value"><%= rec.displayValue %></span><% } %>
                  </div>
                  <% if (rec.description && typeof linkifyDescription === 'function') { %><p class="report-recommendations__desc"><%- linkifyDescription(rec.description) %></p><% } else if (rec.description) { %><p class="report-recommendations__desc"><%= rec.description %></p><% } %>
                </li>
              <% }) %>
            </ul>
          </details>
          <% } %>
        </div>
      </section>
    <% } %>
    <section class="card report-actions report-actions--bar">
      <div class="report-actions__bar">
        <div class="report-actions__primary">
          <a href="/dashboard" class="btn btn--primary"><svg class="icon" aria-hidden="true"><use href="#icon-run"/></svg> New scan</a>
          <button type="button" class="btn btn--ghost report-rescan-btn" data-rescan-url="/scans/<%= s.id %>/rescan" data-rescan-display-url="<%= s.url %>" data-rescan-device="<%= (s.options && s.options.formFactor) === 'desktop' ? 'Desktop' : 'Mobile' %>"><svg class="icon" aria-hidden="true"><use href="#icon-run"/></svg> Re-scan</button>
          <a href="/scans" class="btn btn--ghost"><svg class="icon" aria-hidden="true"><use href="#icon-list"/></svg> Scan history</a>
          <form action="/scans/<%= s.id %>/delete" method="post" class="report-actions__delete-form report-delete-form" data-scan-id="<%= s.id %>">
            <% if (typeof csrfToken !== 'undefined' && csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
            <input type="hidden" name="redirect" value="scans">
            <button type="submit" class="btn btn--ghost report-actions__delete">Delete</button>
          </form>
        </div>
        <div class="report-actions__secondary">
          <% if (s.share_token) { %>
            <button type="button" class="btn btn--ghost report-copy-share-btn" data-share-path="/share/<%= s.share_token %>">Share</button>
            <form action="/scans/<%= s.id %>/unshare" method="post" class="report-actions__inline-form">
              <% if (typeof csrfToken !== 'undefined' && csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
              <button type="submit" class="btn btn--ghost">Disable sharing</button>
            </form>
          <% } else { %>
            <form action="/scans/<%= s.id %>/share" method="post" class="report-actions__inline-form report-share-form" data-share-scan-id="<%= s.id %>">
              <% if (typeof csrfToken !== 'undefined' && csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
              <button type="submit" class="btn btn--ghost">Share</button>
            </form>
          <% } %>
          <% if (s.hasReportJson) { %>
            <a href="/scans/<%= s.id %>/json" download="lighthouse-report.json" class="btn btn--ghost"><svg class="icon" aria-hidden="true"><use href="#icon-download"/></svg> Export</a>
            <a href="/scans/<%= s.id %>/export/pdf" download="lighthouse-report.pdf" class="btn btn--ghost"><svg class="icon" aria-hidden="true"><use href="#icon-download"/></svg> PDF</a>
          <% } %>
        </div>
      </div>
      <% if (!s.hasReportJson) { %>
        <p class="report-actions__muted">Export requires full report. Summary and PDF/JSON export unavailable for this scan.</p>
      <% } %>
    </section>
      </div>
      <% }) %>
    </div>
    <% } else { %>
    <% if (scan.summary && scan.summary.categories && Object.keys(scan.summary.categories).length) { %>
      <section class="card report-scores">
        <h2 class="report-scores__title"><svg class="icon icon--title" aria-hidden="true"><use href="#icon-gauge"/></svg> Overview</h2>
        <div class="score-grid score-grid--report">
          <% Object.entries(scan.summary.categories).forEach(function(entry) {
            var id = entry[0];
            var score = entry[1];
            var label = id.replace(/-/g, ' ');
            label = label.split(' ').map(function(w) { return w.charAt(0).toUpperCase() + w.slice(1); }).join(' ');
          %>
            <div class="score-card score-card--report score-card--category score-card--<%= id %>">
              <span class="score-card__ring" style="--score: <%= score %>"></span>
              <span class="score-label"><%= label %></span>
              <span class="score-value"><%= score %></span>
            </div>
          <% }) %>
        </div>
        <% var perfScore = scan.summary.categories && scan.summary.categories.performance; if (typeof perfScore === 'number' && perfScore < 15) { %>
        <p class="report-scores__hint" role="note">Very low performance score. This can happen due to timeouts, network issues, or a slow environment. Consider re-running the scan from the actions menu above.</p>
        <% } %>
      </section>
    <% } %>
    <% if (scan.summary && scan.summary.metrics && Object.keys(scan.summary.metrics).length) { %><%- include('partials/report-speed-viz', { data: scan, filmstripUrl: hasReportJson ? '/scans/' + scan.id + '/filmstrip' : null }) %><% } %>
    <section class="card report-screenshot">
      <div class="report-screenshot__head">
        <h2 class="card-title">Screenshot</h2>
        <% if (scan.screenshot_path) { %><a href="/scans/<%= scan.id %>/screenshot" target="_blank" rel="noopener" class="report-screenshot__open">Open full size</a><% } %>
      </div>
      <% if (scan.screenshot_path) { %>
        <p class="report-screenshot__caption">Page as captured at the end of the Lighthouse run. Click to view full size.</p>
        <button type="button" class="report-screenshot__preview" id="screenshot-preview" data-screenshot-src="/scans/<%= scan.id %>/screenshot" aria-label="View screenshot full size">
          <img src="/scans/<%= scan.id %>/screenshot" alt="Screenshot of <%= scan.url %>" class="report-screenshot__img" loading="lazy">
        </button>
      <% } else { %>
        <p class="report-screenshot__caption report-screenshot__empty">Screenshot not available for this run. Re-scan to capture a new one.</p>
      <% } %>
    </section>
    <div id="screenshot-overlay" class="screenshot-overlay" hidden aria-modal="true" aria-label="Screenshot full size">
      <div class="screenshot-overlay__backdrop"></div>
      <div class="screenshot-overlay__content">
        <button type="button" class="screenshot-overlay__close" aria-label="Close"><svg class="icon" aria-hidden="true"><use href="#icon-close"/></svg></button>
        <img src="" alt="Screenshot" class="screenshot-overlay__img" id="screenshot-overlay-img">
      </div>
    </div>

    <% if (scan.summary && scan.summary.metrics && Object.keys(scan.summary.metrics).length) { %>
      <section class="card report-metrics">
        <h2 class="card-title">Key metrics</h2>
        <p class="report-metrics__intro">Core Web Vitals and loading metrics from this run.</p>
        <ul class="metrics-list metrics-list--report">
          <% Object.entries(scan.summary.metrics).forEach(function(entry) {
            var id = entry[0];
            var m = entry[1];
            var label = id.replace(/-/g, ' ');
            label = label.split(' ').map(function(w) { return w.charAt(0).toUpperCase() + w.slice(1); }).join(' ');
          %>
            <li class="metrics-list__item">
              <span class="metrics-list__label"><%= label %></span>
              <span class="metrics-list__value"><%= m.displayValue %></span>
            </li>
          <% }) %>
        </ul>
      </section>
    <% } %>
    <% if (scan.summary && scan.summary.recommendations && scan.summary.recommendations.length) { %>
      <%
        var recs = scan.summary.recommendations;
        var byScore = {};
        for (var ri = 0; ri < recs.length; ri++) {
          var sc = recs[ri].score;
          if (!byScore[sc]) byScore[sc] = [];
          byScore[sc].push(recs[ri]);
        }
        var scoreKeys = Object.keys(byScore).map(Number).sort(function(a, b) { return a - b; });
      %>
      <section class="card report-recommendations">
        <h2 class="card-title">Needs attention</h2>
        <p class="report-recommendations__intro">Issues and opportunities from this run, grouped by impact (score).</p>
        <div class="report-recommendations__accordion">
          <% for (var si = 0; si < scoreKeys.length; si++) {
            var scoreVal = scoreKeys[si];
            var items = byScore[scoreVal];
            var scoreClass = scoreVal >= 50 ? 'average' : 'poor';
          %>
          <details class="report-recommendations__accordion-item">
            <summary class="report-recommendations__accordion-summary">
              <span class="report-recommendations__score report-recommendations__score--<%= scoreClass %>"><%= scoreVal %></span>
              <span class="report-recommendations__accordion-label"><%= items.length %> <%= items.length === 1 ? 'issue' : 'issues' %></span>
              <svg class="icon report-recommendations__accordion-chevron" aria-hidden="true"><use href="#icon-chevron-down"/></svg>
            </summary>
            <ul class="report-recommendations__list">
              <% items.forEach(function(rec) { %>
                <li class="report-recommendations__item">
                  <div class="report-recommendations__head">
                    <span class="report-recommendations__title"><%= rec.title %></span>
                    <% if (rec.displayValue) { %><span class="report-recommendations__value"><%= rec.displayValue %></span><% } %>
                  </div>
                  <% if (rec.description && typeof linkifyDescription === 'function') { %><p class="report-recommendations__desc"><%- linkifyDescription(rec.description) %></p><% } else if (rec.description) { %><p class="report-recommendations__desc"><%= rec.description %></p><% } %>
                </li>
              <% }) %>
            </ul>
          </details>
          <% } %>
        </div>
      </section>
    <% } %>

    <section class="card report-actions report-actions--bar">
      <div class="report-actions__bar">
        <div class="report-actions__primary">
          <a href="/dashboard" class="btn btn--primary"><svg class="icon" aria-hidden="true"><use href="#icon-run"/></svg> New scan</a>
          <button type="button" class="btn btn--ghost" id="rescan-btn" data-rescan-url="/scans/<%= scan.id %>/rescan" data-rescan-display-url="<%= scan.url %>" data-rescan-device="<%= (scan.options && scan.options.formFactor) === 'desktop' ? 'Desktop' : 'Mobile' %>"><svg class="icon" aria-hidden="true"><use href="#icon-run"/></svg> Re-scan</button>
          <a href="/scans" class="btn btn--ghost"><svg class="icon" aria-hidden="true"><use href="#icon-list"/></svg> Scan history</a>
          <form action="/scans/<%= scan.id %>/delete" method="post" class="report-actions__delete-form" id="delete-scan-form">
            <% if (typeof csrfToken !== 'undefined' && csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
            <input type="hidden" name="redirect" value="scans">
            <button type="submit" class="btn btn--ghost report-actions__delete">Delete</button>
          </form>
        </div>
        <div class="report-actions__secondary">
          <% if (scan.share_token) { %>
            <button type="button" class="btn btn--ghost" id="copy-share-link" data-share-path="/share/<%= scan.share_token %>">Share</button>
            <form action="/scans/<%= scan.id %>/unshare" method="post" class="report-actions__inline-form">
              <% if (typeof csrfToken !== 'undefined' && csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
              <button type="submit" class="btn btn--ghost">Disable sharing</button>
            </form>
          <% } else { %>
            <form action="/scans/<%= scan.id %>/share" method="post" class="report-actions__inline-form report-share-form" data-share-scan-id="<%= scan.id %>">
              <% if (typeof csrfToken !== 'undefined' && csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
              <button type="submit" class="btn btn--ghost">Share</button>
            </form>
          <% } %>
          <% if (typeof hasReportJson !== 'undefined' && hasReportJson) { %>
            <a href="/scans/<%= scan.id %>/json" download="lighthouse-report.json" class="btn btn--ghost"><svg class="icon" aria-hidden="true"><use href="#icon-download"/></svg> Export</a>
            <a href="/scans/<%= scan.id %>/export/pdf" download="lighthouse-report.pdf" class="btn btn--ghost"><svg class="icon" aria-hidden="true"><use href="#icon-download"/></svg> PDF</a>
          <% } %>
        </div>
      </div>
      <% if (typeof hasReportJson === 'undefined' || !hasReportJson) { %>
        <p class="report-actions__muted">Export requires full report (report too large to store). Summary and PDF/JSON export unavailable for this scan.</p>
      <% } %>
    </section>
    <% } %>
    <div id="share-overlay" class="share-overlay" role="dialog" aria-modal="true" aria-labelledby="share-overlay-title" hidden>
      <div class="share-overlay__panel">
        <h2 id="share-overlay-title" class="share-overlay__title">Share report</h2>
        <p class="share-overlay__hint">Anyone with this link can view the report (read-only).</p>
        <div class="share-overlay__url-wrap">
          <input type="text" id="share-overlay-url" class="share-overlay__url-input" readonly aria-label="Shareable link" value="">
          <button type="button" class="btn btn--primary share-overlay__copy-btn" id="share-overlay-copy">Copy link</button>
        </div>
        <div class="share-overlay__close-wrap">
          <button type="button" class="btn btn--ghost" id="share-overlay-close">Close</button>
        </div>
      </div>
    </div>
    <% if (scanGroup && scanGroup.length >= 2) { %>
    <div id="screenshot-overlay" class="screenshot-overlay" hidden aria-modal="true" aria-label="Screenshot full size">
      <div class="screenshot-overlay__backdrop"></div>
      <div class="screenshot-overlay__content">
        <button type="button" class="screenshot-overlay__close" aria-label="Close"><svg class="icon" aria-hidden="true"><use href="#icon-close"/></svg></button>
        <img src="" alt="Screenshot" class="screenshot-overlay__img" id="screenshot-overlay-img">
      </div>
    </div>
    <% } %>
    <%- include('partials/filmstrip-overlay') %>
  </div>
  <script>
    (function () {
      var overlay = document.getElementById('rescan-overlay');
      var screenshotOverlay = document.getElementById('screenshot-overlay');
      var overlayImg = screenshotOverlay ? screenshotOverlay.querySelector('.screenshot-overlay__img') : null;

      var SCAN_STEPS = ['Loading page…', 'Running Lighthouse audit…', 'Analyzing performance…', 'Capturing screenshot…', 'Almost done…'];
      function startStepRotation(stepEl, ms) {
        if (!stepEl) return function () {};
        var idx = 0;
        stepEl.textContent = SCAN_STEPS[0];
        var t = setInterval(function () {
          idx = (idx + 1) % SCAN_STEPS.length;
          stepEl.textContent = SCAN_STEPS[idx];
        }, ms || 7000);
        return function () { clearInterval(t); };
      }

      function handleRescan(btn) {
        var url = btn && btn.getAttribute('data-rescan-url');
        if (!url || !overlay) return;
        var urlEl = document.getElementById('rescan-overlay-url');
        var deviceEl = document.getElementById('rescan-overlay-device');
        var stepEl = document.getElementById('rescan-overlay-step');
        if (urlEl) urlEl.textContent = btn.getAttribute('data-rescan-display-url') || '';
        if (deviceEl) deviceEl.textContent = btn.getAttribute('data-rescan-device') || '';
        if (urlEl && urlEl.textContent) urlEl.removeAttribute('aria-hidden'); else if (urlEl) urlEl.setAttribute('aria-hidden', 'true');
        if (deviceEl && deviceEl.textContent) deviceEl.removeAttribute('aria-hidden'); else if (deviceEl) deviceEl.setAttribute('aria-hidden', 'true');
        var stopSteps = startStepRotation(stepEl, 7000);
        overlay.removeAttribute('hidden');
        btn.disabled = true;
        var csrfMeta = document.querySelector('meta[name="csrf-token"]');
        var csrf = csrfMeta ? csrfMeta.getAttribute('content') : '';
        fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' }, body: csrf ? new URLSearchParams({ _csrf: csrf }).toString() : '' })
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(d.error || 'Rescan failed'); }).catch(function () { throw new Error('Rescan failed. Try again.'); });
            return r.json();
          })
          .then(function (data) {
            stopSteps();
            if (data && data.redirect) window.location = data.redirect;
            else { overlay.setAttribute('hidden', ''); btn.disabled = false; }
          })
          .catch(function (err) {
            stopSteps();
            overlay.setAttribute('hidden', '');
            btn.disabled = false;
            if (window.showAlert) window.showAlert(err.message || 'Rescan failed. Try again.');
          });
      }

      document.querySelectorAll('.report-rescan-btn, #rescan-btn').forEach(function (btn) {
        btn.addEventListener('click', function () { handleRescan(btn); });
      });

      document.querySelectorAll('.report-delete-form, #delete-scan-form').forEach(function (form) {
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          var f = form;
          if (!window.showConfirm) { f.submit(); return; }
          window.showConfirm('Delete this scan? This cannot be undone.', { title: 'Delete scan', okLabel: 'Delete', danger: true }).then(function (ok) {
            if (ok) f.submit();
          });
        });
      });

      var shareOverlay = document.getElementById('share-overlay');
      var shareOverlayUrl = document.getElementById('share-overlay-url');
      var shareOverlayCopy = document.getElementById('share-overlay-copy');
      var shareOverlayClose = document.getElementById('share-overlay-close');
      function openShareOverlay(url) {
        if (!shareOverlay || !shareOverlayUrl) return;
        shareOverlayUrl.value = url;
        shareOverlay.removeAttribute('hidden');
        shareOverlayUrl.select();
        shareOverlayUrl.setSelectionRange(0, 9999);
        if (shareOverlayCopy) shareOverlayCopy.textContent = 'Copy link';
        document.body.style.overflow = 'hidden';
      }
      function closeShareOverlay() {
        if (shareOverlay) {
          shareOverlay.setAttribute('hidden', '');
          document.body.style.overflow = '';
        }
      }
      document.querySelectorAll('.report-copy-share-btn, #copy-share-link').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
          e.preventDefault();
          var path = btn.getAttribute('data-share-path');
          if (path) openShareOverlay(window.location.origin + path);
        });
      });
      document.querySelectorAll('.report-share-form').forEach(function (form) {
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          var csrfInput = form.querySelector('input[name="_csrf"]');
          var csrf = csrfInput ? csrfInput.value : (document.querySelector('meta[name="csrf-token"]') || {}).content || '';
          var body = new URLSearchParams({ _csrf: csrf });
          fetch(form.action, { method: 'POST', body, headers: { 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' } })
            .then(function (r) {
              if (!r.ok) throw new Error('Share failed');
              return r.json();
            })
            .then(function (data) {
              if (data && data.shareUrl) {
                openShareOverlay(data.shareUrl);
                var shareBtn = form.querySelector('button[type="submit"]');
                if (shareBtn) shareBtn.textContent = 'Share';
              }
            })
            .catch(function () {
              if (window.showAlert) window.showAlert('Could not create share link. Try again.');
            });
        });
      });
      if (shareOverlayCopy && shareOverlayUrl) {
        shareOverlayCopy.addEventListener('click', function () {
          var url = shareOverlayUrl.value;
          if (!url) return;
          function showCopied() {
            shareOverlayCopy.textContent = 'Copied!';
            setTimeout(function () { shareOverlayCopy.textContent = 'Copy link'; }, 2000);
          }
          function showFailed() {
            if (window.showAlert) window.showAlert('Copy failed. Select and copy the link from the box.');
          }
          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            navigator.clipboard.writeText(url).then(showCopied).catch(function () {
              tryFallbackCopy();
            });
          } else {
            tryFallbackCopy();
          }
          function tryFallbackCopy() {
            shareOverlayUrl.focus();
            shareOverlayUrl.select();
            shareOverlayUrl.setSelectionRange(0, 9999);
            try {
              if (document.execCommand('copy')) {
                showCopied();
              } else {
                showFailed();
              }
            } catch (e) {
              showFailed();
            }
          }
        });
      }
      if (shareOverlayClose) shareOverlayClose.addEventListener('click', closeShareOverlay);
      if (shareOverlay) {
        var sharePanel = shareOverlay.querySelector('.share-overlay__panel');
        shareOverlay.addEventListener('click', function (e) {
          if (sharePanel && !sharePanel.contains(e.target)) closeShareOverlay();
        });
        document.addEventListener('keydown', function (e) {
          if (shareOverlay && !shareOverlay.hasAttribute('hidden') && e.key === 'Escape') closeShareOverlay();
        });
      }

      if (screenshotOverlay && overlayImg) {
        var overlayBackdrop = screenshotOverlay.querySelector('.screenshot-overlay__backdrop');
        var overlayClose = screenshotOverlay.querySelector('.screenshot-overlay__close');
        function openScreenshot(src) {
          overlayImg.src = src;
          screenshotOverlay.removeAttribute('hidden');
          document.body.style.overflow = 'hidden';
        }
        function closeScreenshot() {
          screenshotOverlay.setAttribute('hidden', '');
          document.body.style.overflow = '';
        }
        document.querySelector('.report-detail').addEventListener('click', function (e) {
          var preview = e.target.closest('.report-screenshot-preview, [id="screenshot-preview"]');
          if (preview) {
            e.preventDefault();
            var src = preview.getAttribute('data-screenshot-src');
            if (src) openScreenshot(src);
          }
        });
        if (overlayBackdrop) overlayBackdrop.addEventListener('click', closeScreenshot);
        if (overlayClose) overlayClose.addEventListener('click', closeScreenshot);
        document.addEventListener('keydown', function (e) {
          if (e.key === 'Escape' && !screenshotOverlay.hasAttribute('hidden')) closeScreenshot();
        });
      }

      var tabList = document.querySelector('.report-tabs');
      if (tabList) {
        var tabs = tabList.querySelectorAll('.report-tabs__tab');
        var panels = document.querySelectorAll('.report-tab-panel');
        tabs.forEach(function (tab) {
          tab.addEventListener('click', function () {
            var scanId = tab.getAttribute('data-scan-id');
            tabs.forEach(function (t) {
              t.classList.toggle('report-tabs__tab--active', t.getAttribute('data-scan-id') === scanId);
              t.setAttribute('aria-selected', t.getAttribute('data-scan-id') === scanId ? 'true' : 'false');
            });
            panels.forEach(function (p) {
              var active = p.id === 'report-panel-' + scanId;
              p.classList.toggle('report-tab-panel--active', active);
              if (active) p.removeAttribute('hidden');
              else p.setAttribute('hidden', '');
            });
          });
        });
      }
    })();
  </script>
<%- include('partials/footer') %>
